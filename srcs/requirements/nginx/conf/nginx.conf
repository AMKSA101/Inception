# Block all HTTP requests on port 80
server {
	listen 80;
	server_name _;  # Catch all server names
	return 444;     # Close connection without response
}

# Main HTTPS server configuration
server {
	listen 443 ssl http2;
	server_name abamksa.42.fr localhost;

	# Root directory for WordPress
	root /var/www/html;
	index index.php index.html index.htm;

	# SSL Configuration - Optimized
	ssl_certificate /etc/ssl/certs/nginx-selfsigned.crt;
	ssl_certificate_key /etc/ssl/private/nginx-selfsigned.key;
	ssl_protocols TLSv1.2 TLSv1.3;
	ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';
	ssl_prefer_server_ciphers off;
	ssl_session_cache shared:SSL:10m;
	ssl_session_timeout 1d;
	ssl_session_tickets off;
	ssl_stapling off; # Disabled for self-signed cert
	ssl_stapling_verify off; # Disabled for self-signed cert

	# Buffer sizes - Optimized for performance
	client_body_buffer_size 128k;
	client_max_body_size 50M;
	client_header_buffer_size 1k;
	large_client_header_buffers 4 16k;

	# Timeouts - Balanced for all services
	client_body_timeout 30s;
	client_header_timeout 30s;
	keepalive_timeout 65s;
	send_timeout 30s;

	# Security headers - Enhanced
	add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
	add_header X-Frame-Options "SAMEORIGIN" always;
	add_header X-Content-Type-Options "nosniff" always;
	add_header X-XSS-Protection "1; mode=block" always;
	add_header Referrer-Policy "strict-origin-when-cross-origin" always;
	add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

	# Logging
	access_log /var/log/nginx/access.log;
	error_log /var/log/nginx/error.log warn;

	# Adminer - Database management interface
	location /adminer/ {
		# Strip the /adminer prefix and pass to PHP
		rewrite ^/adminer/(.*)$ /$1 break;
		
		# FastCGI configuration for Adminer
		fastcgi_pass adminer:9000;
		fastcgi_index index.php;
		include fastcgi_params;
		fastcgi_param SCRIPT_FILENAME /var/www/adminer/index.php;
		fastcgi_param SCRIPT_NAME /adminer/index.php;
		fastcgi_param REQUEST_URI $request_uri;
		fastcgi_param QUERY_STRING $query_string;
		fastcgi_param HTTPS on;
		fastcgi_param SERVER_NAME $server_name;
		
		# Performance tuning for Adminer
		fastcgi_buffer_size 128k;
		fastcgi_buffers 4 256k;
		fastcgi_busy_buffers_size 256k;
		fastcgi_read_timeout 300;
		fastcgi_send_timeout 300;
		fastcgi_connect_timeout 300;
	}

	# Handle direct access to adminer (without trailing slash)
	location = /adminer {
		return 301 /adminer/;
	}

	# Static portfolio site
	location /portfolio/ {
		# Remove /portfolio prefix and proxy to static site container
		rewrite ^/portfolio/(.*) /$1 break;
		
		proxy_pass http://static-website:8000;
		proxy_http_version 1.1;
		
		# Proxy headers
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_set_header X-Original-URI $request_uri;
		
		# Buffering for better performance
		proxy_buffering on;
		proxy_buffer_size 4k;
		proxy_buffers 8 4k;
		proxy_busy_buffers_size 8k;
		
		# Timeouts
		proxy_connect_timeout 30s;
		proxy_send_timeout 30s;
		proxy_read_timeout 30s;
	}

	# Handle direct access to portfolio (without trailing slash)
	location = /portfolio {
		return 301 /portfolio/;
	}

	# Portainer - Docker management interface
	location /portainer/ {
		# Portainer runs on HTTPS (9443) internally
		proxy_pass https://portainer:9443/;
		proxy_http_version 1.1;
		
		# Required for Portainer to work behind reverse proxy
		proxy_set_header X-Forwarded-Prefix /portainer;
		
		# WebSocket support (REQUIRED for Portainer real-time updates)
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection "upgrade";
		
		# Standard proxy headers
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_set_header X-Forwarded-Host $host;
		proxy_set_header X-Forwarded-Port $server_port;
		
		# Disable SSL verification (Portainer uses self-signed cert)
		proxy_ssl_verify off;
		proxy_ssl_session_reuse on;
		
		# Buffering configuration (disable for WebSocket)
		proxy_buffering off;
		proxy_request_buffering off;
		
		# Extended timeouts for long-running operations
		proxy_connect_timeout 300;
		proxy_send_timeout 300;
		proxy_read_timeout 300;
		
		# Large buffer for Docker API responses
		proxy_buffer_size 128k;
		proxy_buffers 4 256k;
		proxy_busy_buffers_size 256k;
	}

	# Handle direct access to portainer (without trailing slash)
	location = /portainer {
		return 301 /portainer/;
	}

	# PHP handler for WordPress - Optimized
	location ~ \.php$ {
		try_files $uri =404;
		fastcgi_split_path_info ^(.+\.php)(/.+)$;
		fastcgi_pass wordpress:9000;
		fastcgi_index index.php;
		include fastcgi_params;
		fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
		fastcgi_param PATH_INFO $fastcgi_path_info;
		fastcgi_param HTTPS on;
		fastcgi_param SERVER_NAME $server_name;
		
		# Performance optimization
		fastcgi_buffer_size 128k;
		fastcgi_buffers 256 16k;
		fastcgi_busy_buffers_size 256k;
		fastcgi_temp_file_write_size 256k;
		fastcgi_intercept_errors on;
		
		# Extended timeouts for WordPress operations
		fastcgi_read_timeout 300;
		fastcgi_send_timeout 300;
		fastcgi_connect_timeout 300;
	}

	# WordPress main site (root location)
	location / {
		try_files $uri $uri/ /index.php?$args;
	}

	# WordPress admin area - Enhanced
	location /wp-admin/ {
		try_files $uri $uri/ /wp-admin/index.php?$args;
	}

	# WordPress includes - Static files only
	location /wp-includes/ {
		location ~ \.php$ {
			# Allow PHP execution in wp-includes
			try_files $uri =404;
			fastcgi_pass wordpress:9000;
			include fastcgi_params;
			fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
			fastcgi_param HTTPS on;
		}
		try_files $uri $uri/ =404;
	}

	# WordPress content directory
	location /wp-content/ {
		location ~ \.php$ {
			# Block PHP execution in wp-content for security
			deny all;
		}
		try_files $uri $uri/ =404;
	}

	# WordPress uploads - Extra security
	location ~* ^/wp-content/uploads/.*\.(php|php3|php4|php5|phtml|pl|py|jsp|asp|sh|cgi)$ {
		deny all;
		return 403;
	}

	# Prevent access to sensitive WordPress files
	location ~ /wp-config\.php$ {
		deny all;
	}

	location ~ /wp-config-sample\.php$ {
		deny all;
	}

	location ~ /readme\.html$ {
		deny all;
	}

	location ~ /license\.txt$ {
		deny all;
	}

	# Block access to hidden files (except .well-known for Let's Encrypt)
	location ~ /\.(?!well-known).* {
		deny all;
	}

	# Block access to version control directories
	location ~ /\.(git|svn|hg|bzr) {
		deny all;
	}

	# Block access to backup and log files
	location ~* ^.+\.(bak|log|old|orig|original|php~|php#|php.save|php.swp|php.swo|sql|gz|tar|zip)$ {
		deny all;
	}

	# Static files - Aggressive caching with versioning support
	location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg|webp|avif|woff|woff2|ttf|eot|otf)$ {
		expires 1y;
		add_header Cache-Control "public, immutable";
		access_log off;
		log_not_found off;
		
		# Enable gzip compression for text-based static files
		gzip_static on;
	}

	# Media files - Moderate caching
	location ~* \.(mp4|webm|ogg|mp3|wav|flac|aac|pdf|doc|docx|xls|xlsx)$ {
		expires 30d;
		add_header Cache-Control "public";
		access_log off;
	}

	# WordPress favicon
	location = /favicon.ico {
		log_not_found off;
		access_log off;
		expires 1y;
		add_header Cache-Control "public, immutable";
	}

	# WordPress robots.txt
	location = /robots.txt {
		allow all;
		log_not_found off;
		access_log off;
	}

	# WordPress sitemap
	location = /sitemap.xml {
		log_not_found off;
		access_log off;
		try_files $uri $uri/ /index.php?$args;
	}

	location = /sitemap_index.xml {
		log_not_found off;
		access_log off;
		try_files $uri $uri/ /index.php?$args;
	}
}
